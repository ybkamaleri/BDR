---
title: "Insidens for diabetes for barn"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_float:
      collapsed: yes
date: "`r format(Sys.time(), '%d %B %Y')`"
---

# Oppsett

Oppsett for Rmarkdown.

```{r r setup, include=F}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

# Load pakker


```{r}
list.of.packages <- c("data.table", "stringr", "lubridate", "shiny", "flexdashboard",
                      "leaflet","ggplot2","dplyr","sf","ggrepel", "tmap", "mapview")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos = "https://cloud.r-project.org/")
sapply(list.of.packages, require, character.only = TRUE)

```


# Befolkningstall

Basis data for befolkningen hentet fra
[SSB](https://www.ssb.no/statbank/list/folkemengde/ "befolkning"). Når filen er lastet ned så følgende gjøres for å lage fylkes id nr.

- fylke : ID fylke fra SSB
- kartID : ID fra kart sf
- mixID : brukes til å merge Trøndelag


```{r }

norskBF <- fread("N2018_Norge_1_18.csv", header = TRUE, encoding = "Latin-1")

## Extract Alder
norskBF[, age := stringr::str_extract(alder, "\\d+")]
## Extract tall for fylke med gsub
norskBF[, fylke := as.numeric(gsub("([0-9]+).*$", "\\1", region))]

## Kjonn
norskBF[.(kjønn = c("Menn", "Kvinner"), to = 1:2), on = "kjønn", kjonn := i.to]

## SSB data med kartID og mixID for mering Nord og sør Trøndelag
ssbKart <- readRDS("FylkeogKartID.Rds")

## norskBF[, .N, by = .(fylke, region)]
## saveRDS(norskBF, "norskbefolkingUnd19.Rds")


```

# Funksjons

For å hente bare relevant data.


```{r}
selectdiab <- function(x){

  ## Demografisk variabler
  demoVar <-  c("PasientID", "Pnr", "hospital", "hospID", "hosKort", "alder", "Kjonn")

  ## diabetes variabler
  diabetesVar = c("diabetes_Type1", "diabetes_Type2", "diabetes_Mody", "diabetes_Kir62", "diabetes_SekDiabetes", "diabetes_AnnenDiabetes", "diabetes_UkjentDiabetes")

  ## lage subset
  diabDT <- x[, c(demoVar, diabetesVar), with = F]


  ## --- Pasienter uten diagnoser ----
  diabDTx <- copy(diabDT)
  diabDTx[, (diabetesVar) := lapply(.SD, function(x) ifelse(x == "Ja", 1, 0)), .SDcols = diabetesVar]

  diabDTx[, diaSum := sum(.SD, na.rm = TRUE), .SDcols = diabetesVar, by = Pnr]

  ## diabDTx[diaSum == 0, .(Pnr, hosKort)]

  ## Lage en long dataset
  diabLg <- melt(data = diabDT,
                 id.vars = demoVar,
                 measure.vars = diabetesVar,
                 variable.name = "diabType",
                 value.name = "janei")


  ## Omkode diabetes type til tall fra 1 til 7
  diabLg[.(janei = "Ja", diabType = diabetesVar, to = 1:7), on = c("janei", "diabType"), dbt := i.to]

  ## Beholder bare de som svarte Ja
  diabJa <-  diabLg[janei == "Ja", ]

  ## rekode annen type diabetes
  ## 1 = DT1, 2 = DT2, 3 = Mody, 4 = Annen type
  diabJa[, dbtype := dbt][dbt > 3, dbtype := 4]

  return(diabJa)

}

```


# Diabetes data 

Diabetes data for 2018


```{r}
## Diabetes data
## Data path
dataSti <- "~/avid/bdr"
## Load all data årskontroll
DT <- readRDS(file.path(dataSti, "dt2018medBlodTrykk.RDS"))
## Load all data nyoppdaget
DTny <- readRDS(file.path(dataSti, "nyoppdaget20180830.rds"))

utDT <- selectdiab(DT)
utDTny <- selectdiab(DTny)
DT2018 <- rbindlist(list(utDT, utDTny))

## saveRDS(DT2018, (file.path(dataSti, "alleDiabetes2018.Rds")))

```


# Load Data

Laste opp befolkings- og diabetesdata for 2018. Variablene som skal brukes i **DT2018**:

- hospID : Sykehus ID
- sykehusKort : Kort navn for sykehusene
- alder : Pasienten alder
- Kjonn : Kjønn string
- kjonn : Kjønn numeric 1=gutt 2=Jente
- dbtype : Diabetes typer
- fylkeid : ID for fylker


```{r}
## Befolkningsdata
norskBF <- readRDS("norskbefolkingUnd19.Rds")

## Diabetes data 2018
## Data path
dataSti <- "~/avid/bdr"
DT2018 <- readRDS(file.path(dataSti, "alleDiabetes2018.Rds"))


## DT2018[.(hospID = sykehusList[["hospID"]], to = sykehusList[["hosKort"]]),
##        on = "hospID", sykehusKort := i.to]

## DT2018[, .N, by = sykehusKort]

## DT2018[.(Kjonn = c("Gutt", "Jente"), to = 1:2), on = "Kjonn", kjonn := i.to]
## saveRDS(DT2018Fyk, file.path(dataSti, "alleDiabetes2018.Rds"))
```

# Nøkkel SSB data og Diabetes data 
Lager nøkkel for kobling mellom sykehus og fylker fra SSB befolkingstall. Koblingen
må gjøres gjennom sykehus ID fordi fylker har ikke unik nøkkel siden flere sykehus
høres til i samme et fylker.


```{r}

fylkeList <- norskBF[, .N, by = .(region, fylke)][, N := NULL][]
fylkeList
## fylkeList[, fylkeNavn := stringr::str_extract(region, "\\w+")]

sykehusList <- DT2018[, .N, keyby = .(sykehusKort, hospID)][, N := NULL][]
sykehusList

## sykehusList[!sykehusList, on = "hospID"]
## sykehusList[, .N, by = hospID]

## Kobling sykehus og fylke
sykort <- sykehusList[["sykehusKort"]]
sykID <- data.table(sykehusKort = sykort)
sykID[, id := .I]
sykID

## Gir Diabetes data fylkes id
DT2018Fyk <- sykID[DT2018, on = "sykehusKort"]
DT2018Fyk[id == 1, fylkeid := 2] %>%
  .[id == 2, fylkeid := 9] %>%
  .[id == 3, fylkeid := 18] %>%
  .[id == 4, fylkeid := 6] %>%
  .[id == 5, fylkeid := 4] %>%
  .[id == 6, fylkeid := 20] %>%
  .[id == 7, fylkeid := 14] %>%
  .[id == 8, fylkeid := 5] %>%
  .[id == 9, fylkeid := 19] %>%
  .[id == 10, fylkeid := 11] %>%
  .[id == 11, fylkeid := 12] %>%
  .[id == 12, fylkeid := 10] %>%
  .[id == 13, fylkeid := 15] %>%
  .[id == 14, fylkeid := 50] %>%
  .[id == 15, fylkeid := 5] %>%
  .[id == 16, fylkeid := 15] %>%
  .[id == 17, fylkeid := 50] %>%
  .[id == 18, fylkeid := 19] %>%
  .[id == 19, fylkeid := 18] %>%
  .[id == 20, fylkeid := 11] %>%
  .[id == 21, fylkeid := 8] %>%
  .[id == 22, fylkeid := 50] %>%
  .[id == 23, fylkeid := 3] %>%
  .[id == 24, fylkeid := 7] %>%
  .[id == 25, fylkeid := 15] %>%
  .[id == 26, fylkeid := 1]

DT2018Fyk[, .N, by=.(id, hospID, sykehusKort, fylkeid)]
DT2018Fyk[, id := NULL]


fylkSykKob <- kartF[, .(region, hospID, fylkeid)]
## Join sykehus til fylke
fylkSykKob
## saveRDS(fylkSykKob, "sykehusFylker.Rds")


## Load fylke og sykhehus ID kobling
fylkeSykId <- readRDS("sykehusFylker.Rds")
fylkeSykId

## Join fylke til sykehus
sykehusList
SykFylkeAlle <- fylkeSykId[sykehusList, on = "hospID"]
SykFylkeAlle[, fylke := fylkeid]
SykFylkeAlle
## saveRDS(SykFylkeAlle, "FylkeSykehus.Rds")

```

# Norgeskart 

Load fra ferdig behandlet kart med *mapID* og *fylkeid*


```{r}
## saveRDS(norge2018, "NorgeMapFylkeID.Rds")
norgeMapFylke <- readRDS("NorgeMapFylkeID.Rds")

```

Evt. kan laste opp fra start ved bruk Shapefile kart.


```{r}
#kart fylke
NorgeMap = sf::st_read("~/Git-personal/Rujukan-R/norge/NOR_adm1.shp", stringsAsFactors = FALSE)


## bytte Åstfold to Østfold
library(dplyr)
NorgeMap <- NorgeMap %>%
  mutate(NAME_1, fylke=ifelse(ID_1==1, 'Østfold', NAME_1))

## sør- og nord Trøndelag slår sammen siden jan 2018 - gi kode 50
## siden kode fra SSB for Trøndelag er 50
NorgeMap <- NorgeMap %>%
  mutate(ID_1, mapID = ifelse(ID_1 %in% c(9, 14), 50, ID_1))

## gir navn som Trøndelag
NorgeMap <- NorgeMap %>%
  mutate(fylke, region=ifelse(mapID==50, 'Trøndelag', fylke))

## saveRDS(NorgeMap, "kartNorge_sf.RDS")

```


Fil *kartNorge_sf.RDS* har fått Trøndelag med `fID = 50` som ble slått sammen i Jan. 2018. Variablene som skal brukes her:

- region : Oppdatert regionnavn med Trøndelag
- mapID : Ny fylkes id kobinert nord og sør Trøndelag


```{r}

norgeKart <- readRDS("kartNorge_sf.RDS")

## fylke id fra kart
kartKode <- as.data.table(norgeKart)
kartKode[, .N, keyby = .(ID_1, fylke, mapID, region)]

```

## Merge kart for Trøndelag

Nord og Sør-Trøndelag slåss sammen til Trøndelag fra jan 2018. Bruk *mapID* og
*region* til gruppering.

```{r}
norge2018 <- norgeKart %>%
  group_by(mapID, region) %>%
  summarize()

mapView(norge2018, zcol = 'region')

```


# Legger samme id fra SSB og Kart

Fylke ID fra SSB data er ikke det samme ID som er fra kart så de må samkjøres først.


```{r}

fylkeList
fylkeList[fylke == 1, kartID := 1] %>%
  .[fylke == 2, kartID := 2] %>%
  .[fylke == 3, kartID := 12] %>%
  .[fylke == 4, kartID := 6] %>%
  .[fylke == 5, kartID := 11] %>%
  .[fylke == 6, kartID := 4] %>%
  .[fylke == 7, kartID := 19] %>%
  .[fylke == 8, kartID := 16] %>%
  .[fylke == 9, kartID := 3] %>%
  .[fylke == 10, kartID := 18] %>%
  .[fylke == 11, kartID := 13] %>%
  .[fylke == 12, kartID := 7] %>%
  .[fylke == 14, kartID := 15] %>%
  .[fylke == 15, kartID := 8] %>%
  .[fylke == 16, kartID := 14] %>%
  .[fylke == 17, kartID := 9] %>%
  .[fylke == 18, kartID := 10] %>%
  .[fylke == 19, kartID := 17] %>%
  .[fylke == 20, kartID := 20] 

## saveRDS(ssbKart, "FylkeogKartID.Rds")
fylkeList <- readRDS("FylkeogKartID.Rds")

## mixID for å merge Nord og Sør Trøndelag
fylkeList[, mixID := kartID] %>%
  .[kartID  %in% c(14, 9), mixID := 50]

fylkeList


## Gir kart id i fylkeID
ssbKart <- fylkeList[norskBF, on = "fylke"][, i.region := NULL][]
ssbKart[, .N, keyby = .(kartID)]

kartfylke <- 



```


## Legger helseforetaket


```{r}

## Legger til HF
hso <- c("Østfold", "Akershus", "Aust-Agder", "Buskerud", "Hedmark", "Oppland", "Oslo", "Telemark", "Vest-Agder", "Vestfold")
hsv <- c("Hordaland", "Rogaland", "Sogn og Fjordane")
hsm <- c("Møre og Romsdal", "Trøndelag")
hsn <- c("Finnmark", "Nordland", "Troms")


kart_sf <- kart_sf %>%
  mutate(region, helsereg = ifelse(region %in% hso, 1, ifelse(region %in% hsv, 2, ifelse(region %in% hsm, 3, 4))))


## dekningsgrad BDR
kart_sf <- kart_sf %>%
  mutate(helsereg, helsenavn =
                     ifelse(fylke == 1, "Helse Sør-Øst",
                       ifelse(fylke == 2, "Helse Vest",
                         ifelse(fylke == 3, "Helse Midt", "Helse Nord")))) %>%
  mutate(helsereg, dekning =
                     ifelse(fylke == 1, 99,
                       ifelse(fylke == 2, 98,
                         ifelse(fylke == 3, 98, 97))))

```

# Kart med simple feature

Legger prevalence tallene med `sf` package (simple feature)

```{r}
library('dplyr')
kartDT1 <- norgeKart %>% left_join(preDT1, by = c("fID" = "fylkeid"))


library(plotly)
## ## tooltips ved hoving
## plot_ly(
##   kartDT1,
##   split = ~region, #for at hoveron blir categorisert riktig så må bruke 'Split'
##   color = ~fID,
##     text = ~paste("Prevalens pr. 10,000: ", ins10),
##   hoverinfo = "text",
##   hoveron = "fill" #brukes for å vise utvalgte tooltips annen enn district
## )


cols <- c("#89C5DA", "#DA5724", "#74D944", "#CE50CA", "#3F4921", "#C0717C", "#CBD588", "#5F7FC7", "#673770", "#D3D93E", "#38333E", "#508578", "#D7C1B1", "#689030", "#AD6F3B", "#CD9BCD", "#D14285", "#6DDE88", "#652926", "#7FDCC0", "#C84248", "#8569D5", "#5E738F", "#D1A33D", "#8A7C64", "#599861")

## tooltips ved hoving
preDT1Kart <- plot_ly(
  kartDT1,
  split = ~fID, #for at hoveron blir categorisert riktig så må bruke 'Split'
  color = ~region,
  stroke = I("black"),
  text = ~paste("Prevalens pr. 10,000: ", ins10),
  hoverinfo = "text",
  hoveron = "fill", #brukes for å vise utvalgte tooltips annen enn district
  colors = cols
) %>%
  layout(showlegend = FALSE)

preDT1Kart

## dt1Kart = api_create(preDT1Kart, filename="sf-1")
htmlwidgets::saveWidget(as_widget(preDT1Kart), "dt1kart.html")

plotly_IMAGE(preDT1Kart, format = "png", out_file = "dt1kart.png")

```

# Kart med leaflet and co.

Bruker *leaflet, tmap og mapview* pakker.


```{r}
list.of.packages <- c("leaflet","tmap", "mapview")

norDT1 <- tmap::tm_shape(kartDT1) +
  tmap::tm_polygons() +
  tm_shape(preDT1, is.master = TRUE)

kartDT2 <- kartDT1 %>%
  mutate(ID_1 = pre10)

kartDT2

mapView(kartDT1, zcol = "pre10")

```



# Antall barn

Kun barn fra 0 til 18 år.


```{r}

## Antall all per fylker
nbf <- grep("^Personer", names(ssbKart), value = T) #antall befolkningen
NokBF <- ssbKart[, .(N = sum(get(nbf), na.rm = TRUE)),
                 keyby = .(fylke, kartID)][N != 0, ][]

## Antall per kjønn
KjonnBF <- ssbKart[, .(N = sum(get(nbf), na.rm = TRUE)),
                   keyby = .(kjonn, fylke, kartID)][N != 0, ][]

## Antall per alder
AgeBF <- ssbKart[, .(N = sum(get(nbf), na.rm = TRUE)),
                 keyby = .(age, fylke, kartID)][N != 0, ][]

## Antall per alder og kjonn
AgeKjonnBF <- ssbKart[, .(N = sum(get(nbf), na.rm = TRUE)),
                      keyby = .(kjonn, age, fylke, kartID)][N != 0, ][]


```



# Antall pasient per fylker 

Antall pasienter med alle type diabetes og speisfike type. KUN baren under 19 år.

```{r}

dt2018 <- subset(DT2018, alder < 19)
dt2018[.(Kjonn = c("Gutt", "Jente"), to = 1:2), on = "Kjonn", kjonn := i.to]

## Alle type DT
dtFD <- dt2018[, .N, keyby = .(fylkeid)]
dtKjonnFD <- dt2018[, .N, keyby = .(kjonn, fylkeid)]
dtAgeFD <- dt2018[, .N, keyby = .(alder, fylkeid)]
dtAgeKjonnFD <- dt2018[, .N, keyby = .(kjonn, alder, fylkeid)]

## Type 1
dt1FD <- dt2018[dbtype == 1, .N, keyby = fylkeid]
dt1KjonnFD <- dt2018[dbtype == 1, .N, keyby = .(kjonn, fylkeid)]
dt1AgeFD <- dt2018[dbtype == 1, .N, keyby = .(alder, fylkeid)]
dt1AgeKjonnFD <- dt2018[dbtype == 1, .N, keyby = .(kjonn, alder, fylkeid)]


## Type 2
dt2FD <- dt2018[dbtype == 2, .N, keyby = fylkeid]
dt2KjonnFD <- dt2018[dbtype == 2, .N, keyby = .(kjonn, fylkeid)]
dt2AgeFD <- dt2018[dbtype == 2, .N, keyby = .(alder, fylkeid)]
dt2AgeKjonnFD <- dt2018[dbtype == 2, .N, keyby = .(kjonn, alder, fylkeid)]

```

# Prevalence per fylke 

Lager function for å regne prevalence per 10,000 og prosent.


```{r}

## kartID
fylkeList <- readRDS("FylkeogKartID.Rds")

preCount <- function(x, y){

  ## x = DB data
  ## y = fylke data
  preDT <- x[y, on = c(fylkeid = "fylke")]

  preDT[, ins10 := N / i.N * 10000] %>%
    .[, ins := N / i.N * 100]

  utCol <- grep("id$", names(preDT), ignore.case = TRUE)
  tabCol <- names(preDT)[-utCol]
  tabName <- c("case", "pop", "pre10", "pre")
  setnames(preDT, tabCol, tabName)

  preDT[, (tabName) := lapply(.SD, function(x1) round(x1, digits = 1)),
    .SDcols = tabName]

  return(preDT)
}

```

## Alle typer

Antall barn med diabetes av alle typer per 10 000 *ins10*.

```{r}

preDT <- preCount(dtFD, NokBF)[]
preDT

```

## Typer 1 


```{r}

preDT1 <- preCount(dt1FD, NokBF)[]
preDT1


kartDT1 <- norge2018 %>% left_join(preDT1, by = c("fID" = "fylkeid"))
mapView(kartDT1, zcol = "pre10")

```










