---
title: "Insidens for diabetes for barn"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
    toc_float:
      collapsed: yes
date: "`r format(Sys.time(), '%d %B %Y')`"
---

# Oppsett

Oppsett for Rmarkdown.

```{r r setup, include=F}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```

# Load pakker


```{r}
list.of.packages <- c("data.table", "stringr", "lubridate")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos = "https://cloud.r-project.org/")
sapply(list.of.packages, require, character.only = TRUE)

```


# Befolkningstall

Basis data for befolkningen hentet fra
[SSB](https://www.ssb.no/statbank/list/folkemengde/ "befolkning"). Når filen er lastet ned så følgende gjøres for å lage fylkes id nr.

```{r }

norskBF <- fread("N2018_Norge_1_18.csv", header = TRUE, encoding = "Latin-1")

## Extract Alder
norskBF[, age := stringr::str_extract(alder, "\\d+")]
## Extract tall for fylke med gsub
norskBF[, fylke := as.numeric(gsub("([0-9]+).*$", "\\1", region))]

## Kjonn
norskBF[.(kjønn = c("Menn", "Kvinner"), to = 1:2), on = "kjønn", kjonn := i.to]

norskBF[, .N, by = .(fylke, region)]
saveRDS(norskBF, "norskbefolkingUnd19.Rds")

```

# Funksjons

For å hente bare relevant data.


```{r}
selectdiab <- function(x){

  ## Demografisk variabler
  demoVar <-  c("PasientID", "Pnr", "hospital", "hospID", "hosKort", "alder", "Kjonn")

  ## diabetes variabler
  diabetesVar = c("diabetes_Type1", "diabetes_Type2", "diabetes_Mody", "diabetes_Kir62", "diabetes_SekDiabetes", "diabetes_AnnenDiabetes", "diabetes_UkjentDiabetes")

  ## lage subset
  diabDT <- x[, c(demoVar, diabetesVar), with = F]


  ## --- Pasienter uten diagnoser ----
  diabDTx <- copy(diabDT)
  diabDTx[, (diabetesVar) := lapply(.SD, function(x) ifelse(x == "Ja", 1, 0)), .SDcols = diabetesVar]

  diabDTx[, diaSum := sum(.SD, na.rm = TRUE), .SDcols = diabetesVar, by = Pnr]

  ## diabDTx[diaSum == 0, .(Pnr, hosKort)]

  ## Lage en long dataset
  diabLg <- melt(data = diabDT,
                 id.vars = demoVar,
                 measure.vars = diabetesVar,
                 variable.name = "diabType",
                 value.name = "janei")


  ## Omkode diabetes type til tall fra 1 til 7
  diabLg[.(janei = "Ja", diabType = diabetesVar, to = 1:7), on = c("janei", "diabType"), dbt := i.to]

  ## Beholder bare de som svarte Ja
  diabJa <-  diabLg[janei == "Ja", ]

  ## rekode annen type diabetes
  ## 1 = DT1, 2 = DT2, 3 = Mody, 4 = Annen type
  diabJa[, dbtype := dbt][dbt > 3, dbtype := 4]

  return(diabJa)

}

```


# Diabetes data 

Diabetes data for 2018


```{r}
## Diabetes data
## Data path
dataSti <- "~/avid/bdr"
## Load all data årskontroll
DT <- readRDS(file.path(dataSti, "dt2018medBlodTrykk.RDS"))
## Load all data nyoppdaget
DTny <- readRDS(file.path(dataSti, "nyoppdaget20180830.rds"))

utDT <- selectdiab(DT)
utDTny <- selectdiab(DTny)
DT2018 <- rbindlist(list(utDT, utDTny))

## saveRDS(DT2018, (file.path(dataSti, "alleDiabetes2018.Rds")))

```




# Load Data

Laste opp befolkings- og diabetesdata for 2018.


```{r}
## Befolkningsdata
norskBF <- readRDS("norskbefolkingUnd19.Rds")

## Diabetes data 2018
DT2018 <- readRDS(file.path(dataSti, "alleDiabetes2018.Rds"))

```

# Nøkkel
Lager nøkkel for kobling mellom sykehus og fylker. Koblingen må gjøres gjennom
sykehus ID fordi fylker har ikke unik nøkkel siden flere sykehus høres til i samme
et fylker.


```{r}
fylkeList <- norskBF[, .N, by = .(region, fylke)][, N := NULL][]
fylkeList

sykehusList <- DT[, .N, by = .(hosKort, hospID)][, N := NULL][]
sykehusList

## Kobling sykehus og fylke
sykort <- sykehusList[["hosKort"]]
sykID <- data.table(hosKort = sykort)
sykID[, id := .I]
sykID
sykID[id == 1, fylkeid := 2] %>%
  .[id == 2, fylkeid := 9] %>%
  .[id == 3, fylkeid := 18] %>%
  .[id == 4, fylkeid := 6] %>%
  .[id == 5, fylkeid := 4] %>%
  .[id == 6, fylkeid := 20] %>%
  .[id == 7, fylkeid := 14] %>%
  .[id == 8, fylkeid := 5] %>%
  .[id == 9, fylkeid := 19] %>%
  .[id == 10, fylkeid := 11] %>%
  .[id == 11, fylkeid := 12] %>%
  .[id == 12, fylkeid := 10] %>%
  .[id == 13, fylkeid := 15] %>%
  .[id == 14, fylkeid := 50] %>%
  .[id == 15, fylkeid := 5] %>%
  .[id == 16, fylkeid := 15] %>%
  .[id == 17, fylkeid := 50] %>%
  .[id == 18, fylkeid := 19] %>%
  .[id == 19, fylkeid := 18] %>%
  .[id == 20, fylkeid := 11] %>%
  .[id == 21, fylkeid := 8] %>%
  .[id == 22, fylkeid := 50] %>%
  .[id == 23, fylkeid := 3] %>%
  .[id == 24, fylkeid := 7] %>%
  .[id == 25, fylkeid := 15] %>%
  .[id == 26, fylkeid := 1]

idFylker <- sykID[fylkeList, on = c(fylkeid = "fylke")]
sykFylker <- sykehusList[idFylker, on = "hosKort"]

fylkSykKob <- sykFylker[, .(region, hospID, fylkeid)]
## Join sykehus til fylke
fylkSykKob
saveRDS(fylkSykKob, "sykehusFylker.Rds")


## Load fylke og sykhehus ID kobling
fylkeSykId <- readRDS("sykehusFylker.Rds")
fylkeSykId

## Join fylke til sykehus
sykehusList
SykFylkeAlle <- fylkeSykId[sykehusList, on = "hospID"]
SykFylkeAlle[, fylke := fylkeid]
SykFylkeAlle
saveRDS(SykFylkeAlle, "FylkeSykehus.Rds")

```

