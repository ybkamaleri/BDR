---
title: "BDR: Prevalens og insidens"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: row
    vertical_layout: fill
    includes:
      after_body: "busy.html"
---

```{r setup_manual, include=FALSE, eval=FALSE}
list.pkg <- c("flexdashboard", "shiny", "data.table", "dplyr", "plotly", "DT", "leaflet", "lubridate", "magrittr", "tmap", "mapview", "leafpop", "shinycssloaders")
new.packages <- list.pkg[!(list.pkg %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos = "https://cloud.r-project.org/")
## reqopt <- function(x) require(x, quietly = TRUE)
sapply(list.pkg, require, character.only = TRUE)

```

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(data.table)
library(dplyr)
library(leaflet)
library(magrittr)
library(tmap)
library(mapview)
library(leafpop)
library(DT)

pdf(NULL)
```





```{r load_data, include=FALSE}
## load data med HF
mapssb <- readRDS("SSBmedHFogKartID.rds")
dt2018 <- readRDS("DTannonHF.rds")
norgeMapFylke <- readRDS("NorgeMapFylkeID.Rds")
fylkeID <- readRDS("FylkeID.rds")
kartHF <- readRDS("KartHF.rds")
hfID <- readRDS("hfIDList.rds")


## omkode diabetes til T1D og Andre
dt2018[, diab12  :=  dbtype] %>%
  .[dbtype != 1, diab12 := 2]


## function


preCount <- function(x, y, byid = "fylkeid"){
  
  ## x = DB data
  ## y = fylke data
  preDT <- merge(x, y, by = byid)

  preDT[, ins10 := round(N.x / N.y * 10000, digits = 1)] %>%
    .[, ins := round(N.x / N.y * 100, digits = 3)]

  if (byid == "fylkeid"){
    ## columns for fylkeid og mapID
    utCol <- grep("id$", names(preDT), ignore.case = TRUE)
    tabCol <- names(preDT)[-utCol]
  }

  if (byid == "rhf"){ tabCol = names(preDT)[-1]}

  tabName <- c("Case", "Populasjon", "pr.10000", "pr.100")
  setnames(preDT, tabCol, tabName)

  ## preDT[, (tabName) := lapply(.SD, function(x1) round(x1, digits = 1)),
  ##   .SDcols = tabName]
  
  if (byid == "fylkeid"){
    preDT[is.na(mapID), mapID := 50] #for Trøndelag
  }

  return(preDT)
}


```




```{r reaktiv}

## populasjon
pop_ut <- reactive({

  if (input$valg_data == 2){
    dt <- mapssb[kjonn %in% input$valg_kjonn, ] %>%
      .[age >= as.integer(input$valg_age[1]) & age <= as.integer(input$valg_age[2]), ]

    popDT <- dt[, .(N = sum(N)), keyby = .(fylkeid, mapID)]
  }

  if (input$valg_data == 1){
    dt <- mapssb[kjonn %in% input$valg_kjonn, ] %>%
      .[age >= as.integer(input$valg_age[1]) & age <= as.integer(input$valg_age[2]), ]

    popDT <- dt[, .(N = sum(N)), keyby = .(rhf)][!is.na(rhf), ][]
    

  }
  
  return(popDT)
    
})


## diabetes pop
diab_ut <- reactive({
  
  if (input$valg_diab != 3){
    dt1 <- dt2018[diab12 == input$valg_diab, ]
  } else {
    dt1 <- dt2018
  }

  diabData = dt1[kjonn %in% input$valg_kjonn, ] %>%
    .[age >= input$valg_age[1] & age <= input$valg_age[2], ]

  return(diabData)
  
})



## kart
preData_ut <- reactive({

  # Fylke
  if (input$valg_data == 2) {
    if (input$valg_inspre == 1) {
      preNorge <- pop_ut()[, .(N = sum(N, na.rm = TRUE)), keyby = .(fylkeid, mapID)][N != 0, ][]
      preDiab <- diab_ut()[, .N, keyby = .(fylkeid)]
      utDataKart <- preCount(preDiab, preNorge)

    } else {

      #pasienter
      insPas = diab_ut()[valg == 2, .(n = .N), keyby = .(fylkeid)]
      sykPas = diab_ut()[valg == 1, .(ut = .N), keyby = .(fylkeid)]
      insDT = merge(insPas, sykPas, by = "fylkeid", all = TRUE)

      #norges populasjon
      insPop = pop_ut()[, .(pop = sum(N, na.rm = T)), keyby = .(fylkeid, mapID)]
      
      insLand = merge(insDT, insPop, by.x = "fylkeid", by.y = "fylkeid", all.y = TRUE)
      
      tabIns = insLand[pop != 0, ]
      tabIns[is.na(mapID), mapID := 50]
      tabIns[, denom := pop - ut]
      tabIns[, `:=`(ins = round(n / denom * 100, digits = 3), ins10 = round(n / denom * 10000, digits = 2)), by = fylkeid]

      tabName <- c("Case", "Populasjon", "pr.10000", "pr.100")
      setnames(tabIns, c("n", "denom", "ins10", "ins"), tabName)
      utDataKart = tabIns
      
    }
  }

    # HF
  if (input$valg_data == 1) {
    if (input$valg_inspre == 1) {
      preNorge <- pop_ut()[, .(N = sum(N, na.rm = TRUE)), keyby = .(rhf)][N != 0, ][]
      preDiab <- diab_ut()[, .N, keyby = .(rhf)]
      utDataHF <- preCount(preDiab, preNorge, byid = "rhf")
      utDataKart = merge(utDataHF, hfID, by = 'rhf')
      setnames(utDataKart, "rhfNavn", "region")
      
    } else {

      #pasienter
      insPas = diab_ut()[valg == 2, .(n = .N), keyby = .(rhf)]
      sykPas = diab_ut()[valg == 1, .(ut = .N), keyby = .(rhf)]
      insDT = merge(insPas, sykPas, by = "rhf", all = TRUE)

      #norges populasjon
      insPop = pop_ut()[, .(pop = sum(N, na.rm = T)), keyby = .(rhf)]
      
      insLand = merge(insDT, insPop, by = "rhf", all.y = TRUE)
      
      ## tabIns = insLand[pop != 0, ]
      tabIns = insLand
      tabIns[, denom := pop - ut]
      tabIns[, `:=`(ins = round(n / denom * 100, digits = 3), ins10 = round(n / denom * 10000, digits = 2)), by = rhf]

      tabName <- c("Case", "Populasjon", "pr.10000", "pr.100")
      setnames(tabIns, c("n", "denom", "ins10", "ins"), tabName)
      utDataKart = merge(tabIns, hfID, by = "rhf")
      setnames(utDataKart, "rhfNavn", "region")
      utDataKart
      
    }
  }

  
  utDataKart
  
})



## landet
pre_ut <- reactive({
  
  n <- preData_ut()[, sum(Case, na.rm = TRUE)]
  N <- preData_ut()[, sum(Populasjon, na.rm = TRUE)]

  pre1 <- round(n / N * 100, digits = 2)
  pre10 <- round(n / N * 10000, digits = 0)

  preTall = c(pre1, pre10)


  preTall
})


## Kart og data
kartDT_ut <- eventReactive(input$go, {

  if (input$valg_data == 2){
    req(input$valg_inspre)
    kartUT = norgeMapFylke %>% left_join(preData_ut(), by = "mapID")
  }

  
  if (input$valg_data == 1){
    req(input$valg_inspre)
    
    kartUT = kartHF %>% left_join(preData_ut(),  by=c("helsereg"="rhf"))
  }
  
  kartUT
})

```





Sidebar {.sidebar}
===================================

```{r input1}
selectInput("valg_data",
            "Valg nivå: ",
            choices = list(
              "RHF" = 1,
              "Fylke" = 2),
            selected =  2)

```




```{r inspre}



selectInput("valg_inspre",
            "Valg data:",
            choices = list("Prevalens" = 1,
                           "Insidens" = 2),
            selected = 1)
```



```{r typeDiab}
selectInput("valg_diab",
            "Valg diabetes type:",
            choices = list("Type I" = 1,
                           "Annen" = 2,
                           "Alle" = 3),
            selected = 1)

sliderInput("valg_age",
           "Alder:",
           min = 0L,
           max = 14L,
           value = c(0L, 14L),
           step = 1)


checkboxGroupInput("valg_kjonn",
                   "Kjønn:", 
                   choices = list("Gutter" = 1,
                                  "Jenter" = 2
                                  ),
                   selected = c(1, 2),
                   inline = TRUE)

## submitButton("Oppdatere", icon("refresh"))
actionButton("go", " Oppdatere kart", icon("refresh"),
  style="color: #fff; background-color: #447af7; border-color: #2e6da4")

```

<sub> Klikk på kartet for mer informasjon</sub>


[Tilbake til BDR hjemmeside](https://bdreg.github.io)



Pr. 100 personer (%)
===================================


Row
-----------------------------------

### Antall pasienter {.no-title}


```{r}
renderValueBox({
  
  npop = preData_ut()[, sum(Case, na.rm = TRUE)]

  kjonnLg = length(input$valg_kjonn)

  if (kjonnLg == 2) {
    kjonn = " "
  } else {
    kjonn = switch(as.character(input$valg_kjonn),
      "1" = " : Gutter",
      "2" = " : Jenter")
  }
  
  barnTxt <- paste0("Antall pasienter: ", input$valg_age[1], " - ", input$valg_age[2], " år", kjonn)
  valueBox(barnTxt, value = npop, icon = "fa-child")
  
})
```

### Totalt populasjon {.no-title}

```{r}
renderValueBox({

  antallPas = preData_ut()[, sum(Populasjon, na.rm = TRUE)]
  
  barnTxt <- paste0("Total populasjon: ", input$valg_age[1], " - ", input$valg_age[2], " år")
  valueBox(barnTxt, value = antallPas, icon = "fa-user-friends")
})


```

### Prevalens eller Insidens {.no-title}

```{r}
renderValueBox({
  txtInn <- ifelse(input$valg_inspre == 1, "Landet Prevalens", "Landet Insidens")
  valueBox(paste0(txtInn, " (%)"), value = pre_ut()[1],  icon = "fa-pie-chart",color="warning")
})
## valueBox("-2°C", icon = "fa-life-ring",color="rgb(26,110,204)")
```



Row 
---------------------------------------------------

### 

```{r}

output[["kartDT"]] <- renderLeaflet({

  ## Legend title
  valgTxt = ifelse(input$valg_inspre == 1, "Prevalens", "Insidens")
  txtLeg <- paste0(valgTxt, " (", input$valg_age[1], " - ", input$valg_age[2], " år)")

  ## ## Bulid kart
  ## n <- 5000
  ## withProgress(message = 'Restrukturerer kart', value = 0, {

  mapUT <- mapview(kartDT_ut(), zcol = "pr.100",
    popup = leafpop::popupTable(kartDT_ut(), zcol = c("region", "pr.100", "Case", "Populasjon"),
      feature.id = FALSE, row.numbers = FALSE), layer.name = txtLeg)@map
      
      ## for (i in 1:n) {
      ##   # Increment the progress bar, and update the detail text.
      ##   incProgress(1/n, detail = paste("Percent computed ", i, " %"))
      ## }
      
   mapUT
    
  ## })
})

leafletOutput("kartDT")

```




Pr. 10,000 personer
===================================



Row
-----------------------------------

### Antall pasienter {.no-title}


```{r}

renderValueBox({
  
  npop = preData_ut()[, sum(Case, na.rm = TRUE)]

      
  kjonnLg = length(input$valg_kjonn)

  if (kjonnLg == 2) {
    kjonn = " "
  } else {
    kjonn = switch(as.character(input$valg_kjonn),
      "1" = " : Gutter",
      "2" = " : Jenter")
  }
  
  barnTxt <- paste0("Antall pasienter: ", input$valg_age[1], " - ", input$valg_age[2], " år", kjonn)
  valueBox(barnTxt, value = npop, icon = "fa-child")
  
})

```

### Totalt populasjon

```{r}

renderValueBox({

  antallPas = preData_ut()[, sum(Populasjon, na.rm = TRUE)]
  
  barnTxt <- paste0("Total populasjon: ", input$valg_age[1], " - ", input$valg_age[2], " år")
  valueBox(barnTxt, value = antallPas, icon = "fa-user-friends")
})


```

### Prevalens eller Insidens {.no-title}

```{r}
renderValueBox({
  txtInn <- ifelse(input$valg_inspre == 1, "Landet Prevalens", "Landet Insidens")
  valueBox(paste0(txtInn, " pr. 10,000 personer"), value = pre_ut()[2],  icon = "fa-pie-chart",color="warning")
})
## valueBox("-2°C", icon = "fa-life-ring",color="rgb(26,110,204)")
```



Row 
---------------------------------------------------

### 

```{r}

## mapData <- eventReactive(input$go, {
##   kartDT <- norgeMapFylke %>% left_join(preData_ut(), by = "mapID")
## })

output[["kartDT2"]] <- renderLeaflet({

     
  valgTxt = ifelse(input$valg_inspre == 1, "Prevalens", "Insidens")
  txtLeg <- paste0(valgTxt, " (", input$valg_age[1], " - ", input$valg_age[2], " år)")


  ## ## Bulid kart
  ## n <- 5000
  ## withProgress(message = 'Restrukturerer kart', value = 0, {

  mapUT <- mapview(kartDT_ut(), zcol = "pr.10000",
    popup = leafpop::popupTable(kartDT_ut(), zcol = c("region", "pr.10000", "Case", "Populasjon"),
      feature.id = FALSE, row.numbers = FALSE), layer.name = txtLeg)@map
      
      ## for (i in 1:n) {
      ##   # Increment the progress bar, and update the detail text.
      ##   incProgress(1/n, detail = paste("Percent computed ", i, " %"))
      ## }
      
   mapUT
    
  ## })
  
})

## leafletOutput("kartDT2") %>% shinycssloaders::withSpinner()
leafletOutput("kartDT2")

```


Tabell
===================================

<h3>Tabell for basis tall</h3>

Row {data-height=650}
-----------------------------------

```{r}

options(DT.options = list(pageLength = 10))
DT::renderDT({
  
  if (input$valg_data == 2){
    utTabell <- merge(preData_ut(), fylkeID, by = "mapID")
    utTabell[, fylkeid := NULL] %>%
      .[, mapID := NULL]

    if(input$valg_inspre == 2){
      setnames(utTabell, c("Case", "ut", "pop", "Populasjon"), c("Ny pas.", "Allede med diab.", "Populasjon", "'Friske' pop."))
    }
  }

    
  if (input$valg_data == 1){
    utTabell <- merge(preData_ut(), hfID, by = "rhf")
    utTabell[, rhf := NULL] %>%
      .[, rhfNavn := NULL]
    setnames(utTabell, "region", "RHF")

    if(input$valg_inspre == 2){
      setnames(utTabell, c("Case", "ut", "pop", "Populasjon"), c("Ny pas.", "Allede med diab.", "Populasjon", "'Friske' pop."))
    }
  }

  
  return(utTabell)
})

```


Informasjon
===================================

Row
-----------------------------------

### 

  **Om denne nettside**
  
  - Denne nettside er en beta-versjon. Kommentar og forslag til forbedring er
    velkommen og kan sends til [Yusman Kamaleri](mailto:ybkamaleri@gmail.com).

  **Data**

  - Datagrunnlaget inkluderer KUN barn mellom 0 til 14 år som er registeret i BDR.
  - Diabetes pasienter som ikke er registered i BDR blir ikke inkludert i
    analysen. Men med 98% dekningsgrad i BDR i 2018 antar vi at aktuelle tallene
    ikke skal være stor forskjelle med de tallene som er presentert på denne nettside.
  
  
  **Kontakt**
  
  - Ta kontakt med [BDR][bdr] for mer informasjon.



[bdr]:https://bdreg.github.io/06_kontakt.html





