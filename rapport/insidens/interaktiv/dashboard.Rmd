---
title: "BDR: Prevalens og insidens"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: row
    vertical_layout: fill
---

```{r setup, include=FALSE}
list.pkg <- c("flexdashboard", "shiny", "data.table", "dplyr", "plotly", "DT", "leaflet", "lubridate", "magrittr", "tmap", "mapview", "leafpop")
new.packages <- list.pkg[!(list.pkg %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages, repos = "https://cloud.r-project.org/")
## reqopt <- function(x) require(x, quietly = TRUE)
sapply(list.pkg, require, character.only = TRUE)

## function


preCount <- function(x, y){
  
  ## x = DB data
  ## y = fylke data
  preDT <- x[y, on = c(fylkeid = "fylkeID")]

  preDT[, ins10 := N / i.N * 10000] %>%
    .[, ins := N / i.N * 100]

  ## columns for fylkeid og mapID
  utCol <- grep("id$", names(preDT), ignore.case = TRUE)

  tabCol <- names(preDT)[-utCol]
  tabName <- c("Case:", "Populasjon:", "pr.10000", "pr.100")
  setnames(preDT, tabCol, tabName)

  preDT[, (tabName) := lapply(.SD, function(x1) round(x1, digits = 1)),
    .SDcols = tabName]

  preDT[is.na(mapID), mapID := 50] #for Trøndelag
  return(preDT)
}

```


```{r load_data}
## load data
mapssb <- readRDS("SSBmedMapID.Rds")
dt2018 <- readRDS("dtAnnonym.rds")
norgeMapFylke <- readRDS("NorgeMapFylkeID.Rds")

## omkode diabetes til T1D og Andre
dt2018[, diab12  :=  dbtype] %>%
  .[dbtype != 1, diab12 := 2]

```




```{r reaktiv}

## populasjon
pop_ut <- reactive({

  dt <- mapssb[kjonn %in% input$valg_kjonn, ] %>%
    .[age >= as.integer(input$valg_age[1]) & age <= as.integer(input$valg_age[2]), ]

  popDT <- dt[, .(N = sum(N)), keyby = .(fylkeID, mapID)]
  
  return(popDT)
    
})


## diabetes pop
diab_ut <- reactive({

  if (input$valg_diab != 3){
    dt1 <- dt2018[diab12 == input$valg_diab, ]
  } else {
    dt1 <- dt2018
  }
  
  diabData <- dt1[kjonn %in% input$valg_kjonn, ] %>%
    .[age >= input$valg_age[1] & age <= input$valg_age[2], ]

  return(diabData)
  
})


## landet
pre_ut <- reactive({

  n <- nrow(diab_ut())
  N <- sum(pop_ut(), na.rm = TRUE)

  pre1 <- round(n / N * 100, digits = 2)
  pre10 <- round(n / N * 10000, digits = 0)

  preTall <- c(pre1, pre10)

  return(preTall)
})


## kart
preData_ut <- reactive({

  preNorge <- pop_ut()[, .(N = sum(N, na.rm = TRUE)), keyby = .(fylkeID, mapID)][N != 0, ][]
  preDiab <- diab_ut()[, .N, keyby = .(fylkeid)]
  utPre <- preCount(preDiab, preNorge)

  return(utPre)
  
})

```





Sidebar {.sidebar}
===================================


**For barn fra 0 til 14 år**

<hr/>

```{r inspre}
selectInput("valg_inspre",
            "Valg data:",
            choices = list("Prevalens" = 1,
                           "Insidens" = 2),
            selected = 1)
```


```{r typeDiab}
selectInput("valg_diab",
            "Valg diabetes type:",
            choices = list("Type I" = 1,
                           "Annen" = 2,
                           "Alle" = 3),
            selected = 1)

sliderInput("valg_age",
           "Alder:",
           min = 0L,
           max = 14L,
           value = c(0L, 14L),
           step = 1)

checkboxGroupInput("valg_kjonn",
                   "Kjønn:",
                   choices = list("Gutter" = 1,
                                  "Jenter" = 2
                                  ),
                   selected = c(1, 2),
                   inline = TRUE)

```

<hr/>

<sub> Klikk valgte fylke for mer informasjon</sub>

Pr. 100 personer (%)
===================================


Row
-----------------------------------

### Antall pasienter {.no-title}


```{r}
renderValueBox({
  npop <- nrow(diab_ut())
  valueBox("Antall Pasienter", value = npop, icon = "fa-child")
  
})
```

### Totalt populasjon

```{r}
renderValueBox({
  valueBox(value = sum(pop_ut()$N), icon = "fa-user-friends")
})


```

### Prevalens eller Insidens {.no-title}

```{r}
renderValueBox({
  txtInn <- ifelse(input$valg_inspre == 1, "Landet Prevalens", "Landet Insidens")
  valueBox(paste0(txtInn), value = pre_ut()[1],  icon = "fa-pie-chart",color="warning")
})
## valueBox("-2°C", icon = "fa-life-ring",color="rgb(26,110,204)")
```



Row 
---------------------------------------------------

### 

```{r}
renderLeaflet({

  txtLeg <- ifelse(input$valg_inspre == 1, "Prevalens", "Insidens")
  
  kartDT <- norgeMapFylke %>% left_join(preData_ut(), by = "mapID")
  
  ## mapview(kartDT, zcol = "pr100")@map

  mapview(kartDT, zcol = "pr.100",
    popup = leafpop::popupTable(kartDT, zcol = c("region", "pr.100", "Case:", "Populasjon:"),
      feature.id = FALSE, row.numbers = FALSE), layer.name = txtLeg)@map
  
    ## mapview(kartDT, zcol = "pr.100", popup = leafpop::popupTable(kartDT, zcol = 1:2, feature.id = FALSE, row.number = FALSE))@map
  
})
```




Pr. 10,000 personer
===================================




```{r eval=TRUE}
renderPrint({
  
  ## preData_ut()
  ## norgeMapFylke
  kartDT <- norgeMapFylke %>% left_join(preData_ut(), by = "mapID")
  kartDT
})
```
