---
title: "Årskontrollrapport for 2018"
author: ""
date: "23.08.2019"
link-citations: yes
header-includes:
 - \usepackage{booktabs}
 - \usepackage{longtable}
 - \usepackage{array}
 - \usepackage{multirow}
 - \usepackage{wrapfig}
 - \usepackage{float}
 - \usepackage{colortbl}
 - \usepackage{pdflscape}
 - \usepackage{tabu}
 - \usepackage{threeparttable}
 - \usepackage{threeparttablex}
 - \usepackage[normalem]{ulem}
 - \usepackage{makecell}
 - \usepackage[T1]{fontenc}
 - \usepackage{geometry}
 - \geometry{a4paper, total={6in,8in},}
 - \usepackage[utf8]{inputenc}
 - \renewcommand{\contentsname}{Innhold}
 - \renewcommand{\figurename}{Figur}
 - \renewcommand{\tablename}{Tabell}
 - \usepackage{titling}
 - \pretitle{\begin{center}\LARGE\includegraphics[width=6cm]{logo.png}\\[\bigskipamount]}
 - \posttitle{\end{center}}
url: 'http\://bdreg.github.io/'
cover-image: "logo.png"
description: "Benchmark rapport for Barnediabetesregisteret"
output:
  pdf_document:
    toc: true
number_sections: true
theme: lumen
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.pos = 'H')

## pakker
pkg <- c("data.table", "ggplot2", "rreg", "huxtable", "bookdown", "knitr", "rmarkdown", "colorspace", "pier", "stringi", "plotly")
lapply(pkg, library, character.only = TRUE)[[1]]

## Data path
dataSti <- "~/avid/bdr"
## Load all data
DT <- readRDS(file.path(dataSti, "dt2018medBlodTrykk.RDS"))

## ## Diabetes variabler bort med whitespace
## diabetesVar = c("diabetes_Type1", "diabetes_Type2", "diabetes_Mody", "diabetes_Kir62", "diabetes_SekDiabetes", "diabetes_AnnenDiabetes", "diabetes_UkjentDiabetes")
## for (j in diabetesVar){
##   if(class(DT[[j]]) == 'character')
##     set(DT, j = j, value = trimws(DT[[j]]))
## }

## ## Missing pasienter
## DT[PasientID == 3071, diabetes_Mody := "Ja"] #Østfold
## DT[PasientID == 6205, diabetes_UkjentDiabetes := "Ja"] #St. Olav
## saveRDS(DT, file.path(dataSti, "dt2018medBlodTrykk.RDS"))


## Bare TD1 og 'Sandessjøen' er eksludert pga. har bare 1 pasient 
dt1 <- subset(DT, hospID != 5 & diabetes_Type1 == "Ja")

## data type1 fra 2007 - 2017
## dtB4 <- readRDS(file.path(dataSti, "allBDRtype1.rds"))
## dtB4[kodeOld == "ø", hospid := 5] #Sandessjoen
## saveRDS(dtB4, file.path(dataSti, "allBDR2007til2017.rds"))
dtB4 <- readRDS(file.path(dataSti, "allBDR2007til2017.rds"))

## hospital koder
sykehusID <- DT[!duplicated(hospID), .(hosKort, hospital), keyby = hospID]

idx <- c("Ostfold", "Ulleval", "Alesund", "Bodo", "Forde", "Nord_norge", "Gjovik", "Sandessjoen")
idRett <- c("Østfold", "Ullevål", "Ålesund", "Bodø", "Førde", "Tromsø", "Gjøvik", "Sandessjøen")

sykehusID <- sykehusID[.(hosKort = idx, to = idRett), on = "hosKort", hosKort := i.to]
## gir norsk borstaver til datasettet
dt1 <- dt1[.(hosKort = idx, to = idRett), on = "hosKort", hosKort := i.to]
DT <- DT[.(hosKort = idx, to = idRett), on = "hosKort", hosKort := i.to]

## sort per hosKort
setkey(dt1, hosKort)
setkey(DT, hosKort)

## raphist
source("~/Git-work/traume/rapport/annualrap/raphist.R")

## Tabell
source("./analyse/tab.function.R")

```


```{r htmlTemplate, echo=FALSE}
# Create the external file
img <- htmltools::img(src = knitr::image_uri(file.path("./docs", "logo.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:50px; right:1%; padding:10px;z-index:200; width:80px; height:70px;')

htmlhead <- paste0('
<script>
document.write(\'<div class="logos">',img,'</div>\')
</script>
')

readr::write_lines(htmlhead, path = "header.html")

```

# Registrerte pasienter

Figuren viser antall registerte pasienter i 2018 sammenlignet med i 2017.

```{r pasient, fig.width=7, fig.height=8}
source("./analyse/antall_pasient.R")
pasCir
```

# Diabetes type 

```{r tabDiabType}
source("./analyse/diab_type.R")
latex_float(tabOut) <- "H"
tabOut
```
Videre analyse inneholder KUN pasienter med diabetes Type 1. Helgelandssykehuset avd. Sandessjøen har bare en pasient til årskontroll og er tatt ut fra videre analyser.

# Utvalgte pasient-karakteristika

```{r pasKarakter}
source("./analyse/pas_karakter.R")
latex_float(tabOut) <- "H"
tabOut
```

# Aldersfordeling

```{r}
source("./analyse/pas_alder.R")
latex_float(tabOut) <- "H"
tabOut
```

# HbA1c
HbA1c målt på OUS, Aker sykehus.

```{r}
source("./analyse/pas_hba1c_raw.R")
latex_float(tabOut) <- "H"
tabOut
```

# HbA1c fordelt på alder

```{r}
source("./analyse/hba1c_alder.R")
latex_float(tabOut) <- "H"
tabOut
```

# Justert HbA1c 
HbA1c justert for kjønn, alder og sykdomsvarighet.

```{r}
source("./analyse/hba1c_justert.R")
latex_float(tabOut) <- "H"
tabOut
```

# HbA1c sammenligning
HbA1c verdi målt på eget sykehus sammenlignet mot det som er målt sentralt dvs. på Aker sykehus.

```{r samenlikHba1c}
source("./analyse/hba1c_diff.R")

if (knitr::is_latex_output()){
  hbaPlot
}

if (knitr::is_html_output()){
  hbaInt
}
```

# Etnisitet


```{r}
source("./analyse/pas_etnisk.R")
```

Gjennomsnitt HbA1c for nordisk og ikke nordisk pasienter. Nordiske pasienter
defineres som at minst en av foreldene er født i et av de nordiske landene. Analysen
inkluderer KUN pasienter med informasjon om fødeland for minst en av foreldene. `r
norskNA` pasienter er eksludert i denne tabellen pga. manglende informasjon.


```{r}
latex_float(tabOut) <- "H"
tabOut
```

# Akutt komplikasjoner
Tabellen viser antall og andel for innlagt pga. diabetes ketoacidose (DKA),
registerte insulinsjokk med kramper og/eller bevisstløshet, og følinger med behov
for hjelp siste 4 uker. Pasienter som er inkludert i analysen for følinger er bare de
som er 5 år eller eldre.

```{r akutt}
source("./analyse/pas_komplikasjon.R")
latex_float(tabOut) <- "H"
tabOut
```

# Diabetes ketoacidose (DKA)

```{r dka}
source("./analyse/dka.R")
latex_float(tabOut) <- "H"
tabOut
```

# Insulinsjokk

```{r insulin}
source("./analyse/insulin.R")
latex_float(tabOut) <- "H"
tabOut
```

# Insulinsjokk og HbA1c
Antall og andel pasienter med HbA1c < 7.0% og HbA1c < 7.5% som har hatt insulinsjokk.  **Total N** er antall som har data.

```{r inshba}
source("./analyse/inslin_hba1c.R")
latex_float(tabOut) <- "H"
tabOut
```

# Følinger

Andel og antall pasienter med føling med behov for hjelp de siste 4 uker. Kun pasienter fra 5 år og eldre.

```{r foling}
source("./analyse/foling.R")
latex_float(tabOut) <- "H"
tabOut
```

# Følinger og HbA1c
Antall og andel pasienter med HbA1c < 7.0% og HbA1c < 7.5% som har hatt følinger med
behov for hjelp siste 4 uker. **Total N** er antall som har data.

```{r folhba}
source("./analyse/foling_hba1c.R")
latex_float(tabOut) <- "H"
tabOut
```

# Øye- og urinundersøkelse iht. ISPAD Guidelines

Tabellen viser antall og andel pasienter undersøkt i henhold til ISPAD guidelines
(2014) som spesifiserer at pasienter som er 10 år eller eldre med 2 års
sykdomsvarighet eller yngre enn 10 år med 5 års sykdomsvarighet.


```{r ispadTab}
source("./analyse/ispad.R")
latex_float(tabOut) <- "H"
tabOut
```

# Lipider

```{r lipidTab}
source("./analyse/lipider.R")
latex_float(tabOut) <- "H"
tabOut
```

# Persisterende microalbuminuri
Antall og andel med persisterende microalbuminuri (basert på avkrysset data).

```{r micoTab}
source("./analyse/microalbumi.R")
latex_float(tabOut) <- "H"
tabOut
```

# Insulinbehandling

```{r insbehTab}
source("./analyse/insulindose.R")
latex_float(tabOut) <- "H"
tabOut
```


# Insulinpumpe
Gjennomsnittlig antall enheter insulin pr. døgn (bolus og basal) pr. kg kroppsvekt.

```{r tabIns}
latex_float(tabOutIns) <- "H"
tabOutIns
```


# Multiinjeksjonsbehandling (penn)
Gjennomsnittlig antall enheter insulin pr. døgn pr. kg kroppsvekt.

```{r tabMulti}
latex_float(tabOutMult) <- "H"
tabOutMult
```

                                                                         
                                                                         
